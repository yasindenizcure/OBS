@using System.Security.Claims
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var role = User.FindFirst(ClaimTypes.Role)?.Value?.ToLower().Trim();
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --panel-bg: rgba(13, 14, 20, 0.85);
        --panel-border: rgba(0, 243, 255, 0.15);
    }

    .op-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 0 10px;
    }

        .op-header h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 3px;
            color: var(--accent);
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

    .top-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }

    .action-panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(15px);
        display: flex;
        flex-direction: column;
    }

        .action-panel h3 {
            font-family: 'Orbitron';
            font-size: 0.75rem;
            margin-bottom: 15px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 8px;
        }

    .announcement-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 160px;
        overflow-y: auto;
    }

    .announcement-item {
        padding: 10px;
        background: rgba(255, 255, 255, 0.02);
        border-left: 3px solid var(--secondary);
        font-size: 0.8rem;
        line-height: 1.4;
    }

        .announcement-item span {
            display: block;
            color: #64748b;
            font-size: 0.6rem;
            margin-top: 4px;
            font-family: 'Orbitron';
        }

    .action-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .action-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        text-decoration: none;
        color: #e2e8f0;
        transition: 0.2s;
        font-size: 0.8rem;
    }

        .action-item:hover {
            background: rgba(0, 243, 255, 0.08);
            border-color: var(--accent);
            color: var(--accent);
        }

    .bottom-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }

    .chart-panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        padding: 20px;
    }

    .log-terminal {
        background: #000;
        border-radius: 6px;
        padding: 12px;
        font-family: 'monospace';
        font-size: 0.7rem;
        color: #4ade80;
        height: 120px;
        overflow-y: auto;
        border: 1px solid rgba(74, 222, 128, 0.1);
    }

    .log-line {
        margin-bottom: 5px;
        opacity: 0.8;
    }
</style>

<div class="op-header">
    <h2>Dashboard</h2>
    <div style="font-family: 'Orbitron'; font-size: 0.7rem; color: #64748b;">
        DURUM: <span style="color: #4ade80;">AKTİF</span>
    </div>
</div>

<div class="top-grid">
    <div class="action-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;"><i class="fas fa-bullhorn"></i> SİSTEM DUYURULARI</h3>
            @if (role == "admin")
            {
                <a href="/Dashboard/DuyuruYayinla" title="Yeni Duyuru" style="color:var(--accent); font-size:0.8rem;"><i class="fas fa-plus-square"></i></a>
            }
        </div>
        <div class="announcement-list">
            @if (ViewBag.Duyurular != null && ((List<DenemeDers.Entity.Duyuru>)ViewBag.Duyurular).Any())
            {
                foreach (var item in (List<DenemeDers.Entity.Duyuru>)ViewBag.Duyurular)
                {
                    <div class="announcement-item">
                        @item.Icerik
                        <span>@item.Tarih.ToString("dd MMMM yyyy - HH:mm")</span>
                    </div>
                }
            }
            else
            {
                <div class="announcement-item" style="border-left-color:#475569;">
                    Henüz yayınlanmış bir duyuru bulunmuyor.
                </div>
            }
        </div>
    </div>

    <div class="action-panel">
        <h3><i class="fas fa-bolt"></i> HIZLI İSLEMLER</h3>
        <div class="action-list">
            <a href="/Ogrenci/Kayit" class="action-item"><span>Öğrenci Kaydı</span><i class="fas fa-plus"></i></a>
            <a href="/OgretimGorevlisi/OgrGorevlisiKayit" class="action-item"><span>Hoca Tanımla</span><i class="fas fa-plus"></i></a>
            @if (role == "admin")
            {
                <a href="/Bolum/BolumEkle" class="action-item"><span>Yeni Bölüm</span><i class="fas fa-folder-plus"></i></a>
            }
        </div>
    </div>

    <div class="action-panel">
        <h3><i class="fas fa-shield-halved"></i> GÜVENLİK</h3>
        <div class="action-list">
            <div class="action-item">
                <span>Erişim Yetkisi</span>
                <span style="color: var(--accent); font-family: 'Orbitron'; font-size: 0.6rem;">@role?.ToUpper()</span>
            </div>
            <a href="/OgretimGorevlisi/SifreleriTopluHashle" class="action-item"><span>Veri Şifreleme</span><i class="fas fa-lock"></i></a>
        </div>
    </div>
</div>

<div class="bottom-grid">
    <div class="chart-panel">
        <h3 style="font-family:'Orbitron'; font-size:0.8rem; color:var(--accent); margin-bottom:15px;">
            <i class="fas fa-chart-bar"></i> AKADEMİK BASARI ANALİZİ
        </h3>
        <div style="height: 250px;">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>

    <div class="chart-panel">
        <h3 style="font-family:'Orbitron'; font-size:0.8rem; color:var(--accent); margin-bottom:15px;">
            <i class="fas fa-chart-pie"></i> SİSTEM DAGILIMI
        </h3>
        <div style="height: 250px;">
            <canvas id="systemChart"></canvas>
        </div>
    </div>
</div>

<div class="action-panel" style="margin-top:20px;">
    <h3><i class="fas fa-terminal"></i> SON SİSTEM HAREKETLERİ</h3>
    <div class="log-terminal">
        @if (ViewBag.SonIslemler != null)
        {
            foreach (var log in ViewBag.SonIslemler)
            {
                <div class="log-line">
                    [@DateTime.Now.ToString("HH:mm")] > @log.Metin // DURUM: İŞLENDİ
                </div>
            }
        }
        <div class="log-line" style="opacity:0.4;">[@DateTime.Now.ToString("HH:mm")] > BEKLEMEDE...</div>
    </div>
</div>

<script>
    Chart.defaults.color = '#64748b';
    Chart.defaults.font.family = 'Rajdhani';

    const ctxBar = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: @Html.Raw(Json.Serialize(ViewBag.DersAdlari)),
            datasets: [{
                data: @Html.Raw(Json.Serialize(ViewBag.DersOrtalamalari)),
                backgroundColor: 'rgba(0, 243, 255, 0.15)',
                borderColor: '#00f3ff',
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });

    const ctxDoughnut = document.getElementById('systemChart').getContext('2d');
    new Chart(ctxDoughnut, {
        type: 'doughnut',
        data: {
            labels: ['Öğrenciler', 'Hocalar', 'Dersler', 'Bölümler'],
            datasets: [{
                data: [@ViewBag.OgrenciSayisi, @ViewBag.HocaSayisi, @ViewBag.DersSayisi, @ViewBag.BolumSayisi],
                backgroundColor: ['#00f3ff', '#ff00ff', '#ffaa00', '#6366f1'],
                borderColor: 'rgba(0,0,0,0.5)',
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10 } }
            },
            cutout: '70%'
        }
    });
</script>